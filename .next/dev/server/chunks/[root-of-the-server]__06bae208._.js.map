{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/lib/redis.ts"],"sourcesContent":["import IORedis, { Redis } from \"ioredis\";\n\nfunction fixUrl(url: string) {\n  if (!url) {\n    return \"\";\n  }\n  if (url.startsWith(\"redis://\") && !url.startsWith(\"redis://:\")) {\n    return url.replace(\"redis://\", \"redis://:\");\n  }\n  if (url.startsWith(\"rediss://\") && !url.startsWith(\"rediss://:\")) {\n    return url.replace(\"rediss://\", \"rediss://:\");\n  }\n  return url;\n}\n\nclass ClientRedis {\n  static instance: Redis;\n\n  constructor() {\n    throw new Error(\"Use Singleton.getInstance()\");\n  }\n\n  static getInstance(): Redis | null {\n    if (!ClientRedis.instance) {\n      ClientRedis.instance = new IORedis(fixUrl(process.env.REDIS_URL!));\n    }\n    return ClientRedis.instance;\n  }\n}\n\nexport default ClientRedis.getInstance();\n"],"names":[],"mappings":";;;;AAAA;;AAEA,SAAS,OAAO,GAAW;IACzB,IAAI,CAAC,KAAK;QACR,OAAO;IACT;IACA,IAAI,IAAI,UAAU,CAAC,eAAe,CAAC,IAAI,UAAU,CAAC,cAAc;QAC9D,OAAO,IAAI,OAAO,CAAC,YAAY;IACjC;IACA,IAAI,IAAI,UAAU,CAAC,gBAAgB,CAAC,IAAI,UAAU,CAAC,eAAe;QAChE,OAAO,IAAI,OAAO,CAAC,aAAa;IAClC;IACA,OAAO;AACT;AAEA,MAAM;IACJ,OAAO,SAAgB;IAEvB,aAAc;QACZ,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,cAA4B;QACjC,IAAI,CAAC,YAAY,QAAQ,EAAE;YACzB,YAAY,QAAQ,GAAG,IAAI,kHAAO,CAAC,OAAO,QAAQ,GAAG,CAAC,SAAS;QACjE;QACA,OAAO,YAAY,QAAQ;IAC7B;AACF;uCAEe,YAAY,WAAW"}},
    {"offset": {"line": 57, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/lib/clearUrl.ts"],"sourcesContent":["const clearUrl = (url: string) => {\n  const { origin, pathname } = new URL(url);\n  return `${origin}${pathname}`;\n};\n\nexport default clearUrl;\n"],"names":[],"mappings":";;;;AAAA,MAAM,WAAW,CAAC;IAChB,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI;IACrC,OAAO,GAAG,SAAS,UAAU;AAC/B;uCAEe"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/lib/fetchComment.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport type { Comment } from \"../interfaces\";\nimport redis from \"./redis\";\nimport clearUrl from \"./clearUrl\";\n\nexport default async function fetchComment(\n  req: NextApiRequest,\n  res: NextApiResponse,\n) {\n  const url = clearUrl(req.headers.referer);\n\n  if (!redis) {\n    return res.status(500).json({ message: \"Failed to connect to redis.\" });\n  }\n\n  try {\n    // get data\n    const rawComments = await redis.lrange(url, 0, -1);\n\n    // string data to object\n    const comments = rawComments.map((c) => {\n      const comment: Comment = JSON.parse(c);\n      delete comment.user.email;\n      return comment;\n    });\n\n    return res.status(200).json(comments);\n  } catch (_) {\n    return res.status(400).json({ message: \"Unexpected error occurred.\" });\n  }\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;;;AAEe,eAAe,aAC5B,GAAmB,EACnB,GAAoB;IAEpB,MAAM,MAAM,IAAA,mHAAQ,EAAC,IAAI,OAAO,CAAC,OAAO;IAExC,IAAI,CAAC,gHAAK,EAAE;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAA8B;IACvE;IAEA,IAAI;QACF,WAAW;QACX,MAAM,cAAc,MAAM,gHAAK,CAAC,MAAM,CAAC,KAAK,GAAG,CAAC;QAEhD,wBAAwB;QACxB,MAAM,WAAW,YAAY,GAAG,CAAC,CAAC;YAChC,MAAM,UAAmB,KAAK,KAAK,CAAC;YACpC,OAAO,QAAQ,IAAI,CAAC,KAAK;YACzB,OAAO;QACT;QAEA,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;IAC9B,EAAE,OAAO,GAAG;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAA6B;IACtE;AACF"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/lib/getUser.ts"],"sourcesContent":["export default async function getUser(token: string) {\n  const response = await fetch(\n    `https://${process.env.NEXT_PUBLIC_AUTH0_DOMAIN}/userinfo`,\n    {\n      headers: {\n        Authorization: `Bearer ${token}`,\n        \"Content-Type\": \"application/json\",\n      },\n    },\n  );\n  return await response.json();\n}\n"],"names":[],"mappings":";;;;AAAe,eAAe,QAAQ,KAAa;IACjD,MAAM,WAAW,MAAM,MACrB,CAAC,QAAQ,EAAE,QAAQ,GAAG,CAAC,wBAAwB,CAAC,SAAS,CAAC,EAC1D;QACE,SAAS;YACP,eAAe,CAAC,OAAO,EAAE,OAAO;YAChC,gBAAgB;QAClB;IACF;IAEF,OAAO,MAAM,SAAS,IAAI;AAC5B"}},
    {"offset": {"line": 134, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/lib/createComment.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport type { Comment } from \"../interfaces\";\nimport redis from \"./redis\";\nimport { nanoid } from \"nanoid\";\nimport getUser from \"./getUser\";\nimport clearUrl from \"./clearUrl\";\n\nexport default async function createComments(\n  req: NextApiRequest,\n  res: NextApiResponse,\n) {\n  const url = clearUrl(req.headers.referer);\n  const { text } = req.body;\n  const { authorization } = req.headers;\n\n  if (!text || !authorization) {\n    return res.status(400).json({ message: \"Missing parameter.\" });\n  }\n\n  if (!redis) {\n    return res\n      .status(400)\n      .json({ message: \"Failed to connect to redis client.\" });\n  }\n\n  try {\n    // verify user token\n    const user = await getUser(authorization);\n    if (!user) return res.status(400).json({ message: \"Need authorization.\" });\n\n    const { name, picture, sub, email } = user;\n\n    const comment: Comment = {\n      id: nanoid(),\n      created_at: Date.now(),\n      url,\n      text,\n      user: { name, picture, sub, email },\n    };\n\n    // write data\n    await redis.lpush(url, JSON.stringify(comment));\n\n    return res.status(200).json(comment);\n  } catch (_) {\n    return res.status(400).json({ message: \"Unexpected error occurred.\" });\n  }\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;AACA;;;;;;;;;AAEe,eAAe,eAC5B,GAAmB,EACnB,GAAoB;IAEpB,MAAM,MAAM,IAAA,mHAAQ,EAAC,IAAI,OAAO,CAAC,OAAO;IACxC,MAAM,EAAE,IAAI,EAAE,GAAG,IAAI,IAAI;IACzB,MAAM,EAAE,aAAa,EAAE,GAAG,IAAI,OAAO;IAErC,IAAI,CAAC,QAAQ,CAAC,eAAe;QAC3B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAAqB;IAC9D;IAEA,IAAI,CAAC,gHAAK,EAAE;QACV,OAAO,IACJ,MAAM,CAAC,KACP,IAAI,CAAC;YAAE,SAAS;QAAqC;IAC1D;IAEA,IAAI;QACF,oBAAoB;QACpB,MAAM,OAAO,MAAM,IAAA,kHAAO,EAAC;QAC3B,IAAI,CAAC,MAAM,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAAsB;QAExE,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,GAAG,EAAE,KAAK,EAAE,GAAG;QAEtC,MAAM,UAAmB;YACvB,IAAI,IAAA,sHAAM;YACV,YAAY,KAAK,GAAG;YACpB;YACA;YACA,MAAM;gBAAE;gBAAM;gBAAS;gBAAK;YAAM;QACpC;QAEA,aAAa;QACb,MAAM,gHAAK,CAAC,KAAK,CAAC,KAAK,KAAK,SAAS,CAAC;QAEtC,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;IAC9B,EAAE,OAAO,GAAG;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAA6B;IACtE;AACF"}},
    {"offset": {"line": 197, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/lib/deleteComment.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport type { User, Comment } from \"../interfaces\";\nimport redis from \"./redis\";\nimport getUser from \"./getUser\";\nimport clearUrl from \"./clearUrl\";\n\nexport default async function deleteComments(\n  req: NextApiRequest,\n  res: NextApiResponse,\n) {\n  const url = clearUrl(req.headers.referer);\n  const { comment }: { url: string; comment: Comment } = req.body;\n  const { authorization } = req.headers;\n\n  if (!comment || !authorization) {\n    return res.status(400).json({ message: \"Missing parameter.\" });\n  }\n\n  if (!redis) {\n    return res.status(500).json({ message: \"Failed to connect to redis.\" });\n  }\n\n  try {\n    // verify user token\n    const user: User = await getUser(authorization);\n    if (!user) return res.status(400).json({ message: \"Invalid token.\" });\n    comment.user.email = user.email;\n\n    const isAdmin = process.env.NEXT_PUBLIC_AUTH0_ADMIN_EMAIL === user.email;\n    const isAuthor = user.sub === comment.user.sub;\n\n    if (!isAdmin && !isAuthor) {\n      return res.status(400).json({ message: \"Need authorization.\" });\n    }\n\n    // delete\n    await redis.lrem(url, 0, JSON.stringify(comment));\n\n    return res.status(200).end();\n  } catch (err) {\n    return res.status(400);\n  }\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;AACA;;;;AAEe,eAAe,eAC5B,GAAmB,EACnB,GAAoB;IAEpB,MAAM,MAAM,IAAA,mHAAQ,EAAC,IAAI,OAAO,CAAC,OAAO;IACxC,MAAM,EAAE,OAAO,EAAE,GAAsC,IAAI,IAAI;IAC/D,MAAM,EAAE,aAAa,EAAE,GAAG,IAAI,OAAO;IAErC,IAAI,CAAC,WAAW,CAAC,eAAe;QAC9B,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAAqB;IAC9D;IAEA,IAAI,CAAC,gHAAK,EAAE;QACV,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAA8B;IACvE;IAEA,IAAI;QACF,oBAAoB;QACpB,MAAM,OAAa,MAAM,IAAA,kHAAO,EAAC;QACjC,IAAI,CAAC,MAAM,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,SAAS;QAAiB;QACnE,QAAQ,IAAI,CAAC,KAAK,GAAG,KAAK,KAAK;QAE/B,MAAM,UAAU,0DAA8C,KAAK,KAAK;QACxE,MAAM,WAAW,KAAK,GAAG,KAAK,QAAQ,IAAI,CAAC,GAAG;QAE9C,IAAI,CAAC,WAAW,CAAC,UAAU;YACzB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,SAAS;YAAsB;QAC/D;QAEA,SAAS;QACT,MAAM,gHAAK,CAAC,IAAI,CAAC,KAAK,GAAG,KAAK,SAAS,CAAC;QAExC,OAAO,IAAI,MAAM,CAAC,KAAK,GAAG;IAC5B,EAAE,OAAO,KAAK;QACZ,OAAO,IAAI,MAAM,CAAC;IACpB;AACF"}},
    {"offset": {"line": 248, "column": 0}, "map": {"version":3,"sources":["file:///Users/leilalu/Documents/leila.no/pages/api/comment.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport fetchComment from \"../../lib/fetchComment\";\nimport createComments from \"../../lib/createComment\";\nimport deleteComments from \"../../lib/deleteComment\";\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse,\n) {\n  switch (req.method) {\n    case \"GET\":\n      return fetchComment(req, res);\n    case \"POST\":\n      return createComments(req, res);\n    case \"DELETE\":\n      return deleteComments(req, res);\n    default:\n      return res.status(400).json({ message: \"Invalid method.\" });\n  }\n}\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;;;;;;AAEe,eAAe,QAC5B,GAAmB,EACnB,GAAoB;IAEpB,OAAQ,IAAI,MAAM;QAChB,KAAK;YACH,OAAO,IAAA,uHAAY,EAAC,KAAK;QAC3B,KAAK;YACH,OAAO,IAAA,wHAAc,EAAC,KAAK;QAC7B,KAAK;YACH,OAAO,IAAA,wHAAc,EAAC,KAAK;QAC7B;YACE,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,SAAS;YAAkB;IAC7D;AACF"}}]
}